---
heat_template_version: pike

description: >
  Heat stack template for a stack containing three Neutron ports.
  Each is on a named network and subnet (and does not have a floating IP).
  The first port listed is considered a primary interface, and the IP 
  associated with the first port is used for subsequent interaction with
  the node.

parameters:
  node_idx:
    type: number
    label: Node index within cluster group
  cluster_net:
    type: json
    label: Network names and subnets to which the nodes should be attached
  cluster_fips:
    type: json
    label: List of UUIDs of prealloacted floating IPs
    default: []

conditions:
  security_groups_set:
    yaql:
      expression: $.data.cluster_net.containsKey('security_groups')
      data:
        cluster_net: { get_param: [ cluster_net, 0 ] }

resources:
  port1:
    type: OS::GroupBasedPolicy::PolicyTarget
    properties:
      policy_target_group_id: { get_param: [ cluster_net, 0, ptg ] }
      name:
        str_replace:
          template: pt%-idx%
          params:
            "pt%":  {get_param: [ cluster_net, 0, name ] } 
            "idx%": { get_param: node_idx }

  port2:
    type: OS::GroupBasedPolicy::PolicyTarget
    properties:
      policy_target_group_id: { get_param: [ cluster_net, 1, ptg ] }
      name:
        str_replace:
          template: pt%-idx%
          params:
            "pt%":  {get_param: [ cluster_net, 1, name ] } 
            "idx%": { get_param: node_idx }
  port3:
    type: OS::GroupBasedPolicy::PolicyTarget
    properties:
      policy_target_group_id: { get_param: [ cluster_net, 2, ptg ] }
      name:
        str_replace:
          template: pt%-idx%
          params:
            "pt%":  {get_param: [ cluster_net, 2, name ] } 
            "idx%": { get_param: node_idx }            

outputs:
  OS::stack_id:
    description: The network list
    value: 
      - port1: { get_resource: port1 }
      - port2: { get_resource: port2 }
      - port3: { get_resource: port3 }

  networks:
    description: The network list
    value: 
      - port: { get_attr: [port1, port_id] }
      - port: { get_attr: [port2, port_id] }
      - port: { get_attr: [port3, port_id] }

  primary_ip:
    description: ID of the IP assigned on the named cluster network
    value: 
